<!DOCTYPE html>

<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üí∞ Gestion de Caisse</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
  <div id="root">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <p class="text-gray-600">Chargement...</p>
      </div>
    </div>
  </div>

  <script>
    const CREDS = { identifiant: "admin", code: "1234" };
    const ALERT_MIN = 50; // Alerte si fond < 50‚Ç¨
    const ALERT_MAX = 500; // Alerte si fond > 500‚Ç¨
    
    const state = {
      auth: localStorage.getItem("isAuthenticated") === "true",
      tab: "recettes",
      recettes: JSON.parse(localStorage.getItem("recettes") || "[]"),
      fonds: JSON.parse(localStorage.getItem("fondsCaisse") || "[]"),
      showForm: false,
      showStats: false,
      form: { montant: "", date: new Date().toISOString().slice(0,10), note: "", categorie: "especes" }
    };

    function save() {
      localStorage.setItem("recettes", JSON.stringify(state.recettes));
      localStorage.setItem("fondsCaisse", JSON.stringify(state.fonds));
    }

    function exportCSV() {
      const data = state.tab === "recettes" ? state.recettes : state.fonds;
      if (data.length === 0) { alert("Aucune donn√©e √† exporter"); return; }

      let csv = state.tab === "recettes" 
        ? "Date,Montant,Cat√©gorie,Note\n"
        : "Date,Montant\n";

      data.forEach(item => {
        if (state.tab === "recettes") {
          const cat = item.categorie === "especes" ? "Esp√®ces" : item.categorie === "cb" ? "CB" : "Borne";
          csv += `${item.date},${item.montant},${cat},"${item.note || ""}"\n`;
        } else {
          csv += `${item.date},${item.montant}\n`;
        }
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", `${state.tab}_${new Date().toISOString().slice(0,10)}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function getStats() {
      const today = new Date();
      const last7Days = state.recettes.filter(r => {
        const diff = (today - new Date(r.date)) / (1000 * 60 * 60 * 24);
        return diff >= 0 && diff < 7;
      });
      const last30Days = state.recettes.filter(r => {
        const diff = (today - new Date(r.date)) / (1000 * 60 * 60 * 24);
        return diff >= 0 && diff < 30;
      });

      const sum7 = last7Days.reduce((s, r) => s + r.montant, 0);
      const sum30 = last30Days.reduce((s, r) => s + r.montant, 0);

      return {
        avgDay: last7Days.length > 0 ? sum7 / Math.min(7, last7Days.length) : 0,
        avgWeek: sum7,
        avgMonth: sum30,
        total7: sum7,
        total30: sum30,
        count7: last7Days.length,
        count30: last30Days.length
      };
    }

    function render() {
      const root = document.getElementById("root");
      if (!state.auth) {
        root.innerHTML = `
          <div class="min-h-screen bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
              <div class="text-center mb-8">
                <div class="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                  <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                  </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Gestion de Caisse</h1>
                <p class="text-gray-600">Connectez-vous pour continuer</p>
              </div>
              <form id="loginForm" class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Identifiant</label>
                  <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="admin" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Code</label>
                  <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="1234" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold transition shadow-lg">
                  Se connecter
                </button>
              </form>
              <div class="mt-4 text-xs text-gray-500 text-center">
                Par d√©faut: admin / 1234
              </div>
            </div>
          </div>
        `;
        document.getElementById("loginForm").onsubmit = (e) => {
          e.preventDefault();
          const user = document.getElementById("username").value;
          const pass = document.getElementById("password").value;
          if (user === CREDS.identifiant && pass === CREDS.code) {
            state.auth = true;
            localStorage.setItem("isAuthenticated", "true");
            render();
          } else {
            alert("Identifiant ou code incorrect");
          }
        };
        return;
      }

      const data = state.tab === "recettes" ? state.recettes : state.fonds;
      const today = new Date().toISOString().slice(0,10);
      const month = new Date().getMonth();
      const year = new Date().getFullYear();

      const fmt = (n) => (n || 0).toFixed(2) + " ‚Ç¨";

      let recettesStats = "";
      if (state.tab === "recettes") {
        const dayTotal = data.filter(x => x.date === today).reduce((s, x) => s + x.montant, 0);
        const monthTotal = data.filter(x => {
          const d = new Date(x.date);
          return d.getMonth() === month && d.getFullYear() === year;
        }).reduce((s, x) => s + x.montant, 0);

        function catTotal(cat, mode) {
          return data.filter(x => {
            if (x.categorie !== cat) return false;
            if (mode === "day") return x.date === today;
            const d = new Date(x.date);
            return d.getMonth() === month && d.getFullYear() === year;
          }).reduce((s, x) => s + x.montant, 0);
        }

        const dayEsp = catTotal("especes", "day");
        const dayCB = catTotal("cb", "day");
        const dayBorne = catTotal("borne", "day");
        const monthEsp = catTotal("especes", "month");
        const monthCB = catTotal("cb", "month");
        const monthBorne = catTotal("borne", "month");

        const stats = getStats();

        recettesStats = `
          <div class="bg-green-500 rounded-xl p-6 text-white mb-4 shadow-lg">
            <div class="mb-4">
              <p class="text-sm opacity-90 mb-1">Total du jour</p>
              <p class="text-3xl font-bold">${fmt(dayTotal)}</p>
            </div>
            <div class="border-t border-white/20 pt-4">
              <p class="text-sm opacity-90 mb-1">Total du mois</p>
              <p class="text-2xl font-bold">${fmt(monthTotal)}</p>
            </div>
          </div>

          <div class="bg-white rounded-xl p-4 mb-4 shadow">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-semibold text-gray-700">üìä Statistiques</h3>
              <button id="toggleStats" class="text-xs text-blue-600 hover:text-blue-700">${state.showStats ? "Masquer" : "Afficher"}</button>
            </div>
            ${state.showStats ? `
              <div class="grid grid-cols-2 gap-3 text-sm">
                <div class="bg-blue-50 p-3 rounded-lg">
                  <p class="text-xs text-gray-600 mb-1">Moyenne/jour (7j)</p>
                  <p class="text-lg font-bold text-blue-700">${fmt(stats.avgDay)}</p>
                </div>
                <div class="bg-purple-50 p-3 rounded-lg">
                  <p class="text-xs text-gray-600 mb-1">Total 7 derniers jours</p>
                  <p class="text-lg font-bold text-purple-700">${fmt(stats.total7)}</p>
                </div>
                <div class="bg-indigo-50 p-3 rounded-lg">
                  <p class="text-xs text-gray-600 mb-1">Total 30 derniers jours</p>
                  <p class="text-lg font-bold text-indigo-700">${fmt(stats.total30)}</p>
                </div>
                <div class="bg-green-50 p-3 rounded-lg">
                  <p class="text-xs text-gray-600 mb-1">Nb de recettes (30j)</p>
                  <p class="text-lg font-bold text-green-700">${stats.count30}</p>
                </div>
              </div>
            ` : ''}
          </div>

          <div class="grid grid-cols-3 gap-3 mb-6">
            <div class="bg-white rounded-lg p-4 shadow">
              <p class="text-sm font-medium text-gray-600 mb-2">üíµ Esp√®ces</p>
              <p class="text-xl font-bold text-gray-800">${fmt(dayEsp)}</p>
              <p class="text-xs text-gray-500 mt-1">Mois: ${fmt(monthEsp)}</p>
            </div>
            <div class="bg-white rounded-lg p-4 shadow">
              <p class="text-sm font-medium text-gray-600 mb-2">üí≥ CB</p>
              <p class="text-xl font-bold text-gray-800">${fmt(dayCB)}</p>
              <p class="text-xs text-gray-500 mt-1">Mois: ${fmt(monthCB)}</p>
            </div>
            <div class="bg-white rounded-lg p-4 shadow">
              <p class="text-sm font-medium text-gray-600 mb-2">üì± Borne</p>
              <p class="text-xl font-bold text-gray-800">${fmt(dayBorne)}</p>
              <p class="text-xs text-gray-500 mt-1">Mois: ${fmt(monthBorne)}</p>
            </div>
          </div>
        `;
      } else {
        const dernierFond = data.length > 0 ? data[data.length - 1].montant : 0;
        let alertClass = "";
        let alertMsg = "";
        
        if (dernierFond < ALERT_MIN) {
          alertClass = "bg-red-500";
          alertMsg = `‚ö†Ô∏è Alerte : Fond de caisse faible (< ${ALERT_MIN}‚Ç¨)`;
        } else if (dernierFond > ALERT_MAX) {
          alertClass = "bg-orange-500";
          alertMsg = `‚ö†Ô∏è Alerte : Fond de caisse √©lev√© (> ${ALERT_MAX}‚Ç¨)`;
        } else {
          alertClass = "bg-blue-500";
        }

        recettesStats = `
          <div class="${alertClass} rounded-xl p-6 text-white mb-4 shadow-lg">
            <p class="text-sm opacity-90 mb-1">Fond de caisse actuel</p>
            <p class="text-4xl font-bold">${fmt(dernierFond)}</p>
            <p class="text-xs opacity-75 mt-2">Monnaie disponible dans la caisse</p>
          </div>
          ${alertMsg ? `
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 rounded">
              <p class="text-sm text-yellow-800">${alertMsg}</p>
            </div>
          ` : ''}
        `;
      }

      root.innerHTML = `
        <div class="min-h-screen p-4">
          <div class="max-w-4xl mx-auto">
            <div class="flex items-center justify-between mb-6">
              <h1 class="text-3xl font-bold text-gray-800">üí∞ Gestion de Caisse</h1>
              <div class="flex gap-2">
                <button id="exportBtn" class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg font-medium transition shadow text-sm">
                  üì• Export
                </button>
                <button id="logout" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition shadow text-sm">
                  D√©connexion
                </button>
              </div>
            </div>

            <div class="flex gap-2 mb-6">
              <button id="tabRecettes" class="flex-1 py-3 px-4 rounded-lg font-semibold transition ${state.tab === "recettes" ? "bg-green-500 text-white shadow-lg" : "bg-white text-gray-600"}">
                üìà Recettes
              </button>
              <button id="tabFonds" class="flex-1 py-3 px-4 rounded-lg font-semibold transition ${state.tab === "fondsCaisse" ? "bg-blue-500 text-white shadow-lg" : "bg-white text-gray-600"}">
                üíµ Fond de Caisse
              </button>
            </div>

            ${recettesStats}

            <button id="addBtn" class="w-full ${state.tab === "recettes" ? "bg-green-500 hover:bg-green-600" : "bg-blue-500 hover:bg-blue-600"} text-white py-4 rounded-xl font-semibold mb-6 shadow-lg transition">
              + ${state.tab === "recettes" ? "Ajouter une recette" : "D√©finir le fond de caisse"}
            </button>

            ${state.showForm ? `
              <div class="bg-white rounded-xl p-6 mb-6 shadow-lg">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">${state.tab === "recettes" ? "Nouvelle recette" : "D√©finir le fond de caisse"}</h3>
                
                ${state.tab === "recettes" ? `
                  <div class="grid grid-cols-2 gap-2 mb-4">
                    <label class="flex items-center justify-center gap-2 bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-4 cursor-pointer hover:bg-gray-200">
                      <input type="file" id="photoInput" accept="image/*" capture="environment" class="hidden">
                      üì∏ Photo
                    </label>
                    <label class="flex items-center justify-center gap-2 bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-4 cursor-pointer hover:bg-gray-200">
                      <input type="file" id="galleryInput" accept="image/*" class="hidden">
                      üñºÔ∏è Galerie
                    </label>
                  </div>

                  <div class="grid grid-cols-3 gap-2 mb-4">
                    <button id="catEsp" class="p-3 rounded-lg border-2 ${state.form.categorie === "especes" ? "border-green-500 bg-green-50 text-green-700" : "border-gray-300"}">üíµ Esp√®ces</button>
                    <button id="catCB" class="p-3 rounded-lg border-2 ${state.form.categorie === "cb" ? "border-blue-500 bg-blue-50 text-blue-700" : "border-gray-300"}">üí≥ CB</button>
                    <button id="catBorne" class="p-3 rounded-lg border-2 ${state.form.categorie === "borne" ? "border-purple-500 bg-purple-50 text-purple-700" : "border-gray-300"}">üì± Borne</button>
                  </div>
                ` : ''}

                <div class="grid ${state.tab === "recettes" ? "grid-cols-3" : "grid-cols-2"} gap-4 mb-4">
                  <input type="number" step="0.01" id="montant" value="${state.form.montant}" placeholder="Montant (‚Ç¨)" class="px-4 py-3 border border-gray-300 rounded-lg">
                  <input type="date" id="date" value="${state.form.date}" class="px-4 py-3 border border-gray-300 rounded-lg">
                  ${state.tab === "recettes" ? '<input type="text" id="note" value="' + state.form.note + '" placeholder="Note (optionnel)" class="px-4 py-3 border border-gray-300 rounded-lg">' : ''}
                </div>

                <div class="flex gap-2">
                  <button id="saveBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-semibold">Enregistrer</button>
                  <button id="cancelBtn" class="px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold">Annuler</button>
                </div>
              </div>
            ` : ''}

            <div class="bg-white rounded-xl p-6 shadow-lg">
              <h3 class="text-lg font-semibold text-gray-700 mb-4">Historique</h3>
              ${data.length === 0 ? '<p class="text-center py-10 text-gray-500">Aucune entr√©e</p>' : `
                <div class="space-y-3">
                  ${data.sort((a,b) => (b.date || "").localeCompare(a.date || "")).map(it => `
                    <div class="flex items-start justify-between gap-3 p-4 rounded-lg border border-gray-200">
                      <div>
                        ${state.tab === "recettes" ? `
                          <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs px-2 py-1 rounded-full bg-gray-100">${it.categorie === "especes" ? "üíµ Esp√®ces" : it.categorie === "cb" ? "üí≥ CB" : "üì± Borne"}</span>
                            <span class="text-sm text-gray-500">${it.date}</span>
                          </div>
                        ` : `
                          <span class="text-sm text-gray-500 block mb-1">${it.date}</span>
                        `}
                        <div class="text-lg font-bold">${fmt(it.montant)}</div>
                        ${it.note ? `<div class="text-sm text-gray-600">${it.note}</div>` : ''}
                      </div>
                      <button onclick="delEntry(${it.id})" class="px-3 py-2 bg-red-50 hover:bg-red-100 text-red-700 rounded-lg text-sm font-medium">Supprimer</button>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        </div>
      `;

      document.getElementById("logout").onclick = () => {
        state.auth = false;
        localStorage.removeItem("isAuthenticated");
        render();
      };

      document.getElementById("exportBtn").onclick = exportCSV;
      document.getElementById("tabRecettes").onclick = () => { state.tab = "recettes"; state.showForm = false; render(); };
      document.getElementById("tabFonds").onclick = () => { state.tab = "fondsCaisse"; state.showForm = false; render(); };
      document.getElementById("addBtn").onclick = () => { state.showForm = !state.showForm; render(); };

      if (state.tab === "recettes" && document.getElementById("toggleStats")) {
        document.getElementById("toggleStats").onclick = () => { state.showStats = !state.showStats; render(); };
      }

      if (state.showForm) {
        if (state.tab === "recettes") {
          const handlePhoto = async (file) => {
            if (!file || !window.Tesseract) return;
            try {
              const { data: { text } } = await window.Tesseract.recognize(file, "fra");
              const nums = (text.match(/\d{1,6}(?:[.,]\d{1,2})?/g) || []).map(s => parseFloat(s.replace(",", "."))).filter(v => !isNaN(v));
              if (nums.length) {
                state.form.montant = String(Math.max(...nums));
                document.getElementById("montant").value = state.form.montant;
              }
            } catch (e) { console.error(e); }
          };

          document.getElementById("photoInput").onchange = (e) => handlePhoto(e.target.files[0]);
          document.getElementById("galleryInput").onchange = (e) => handlePhoto(e.target.files[0]);
          
          document.getElementById("catEsp").onclick = () => { state.form.categorie = "especes"; render(); };
          document.getElementById("catCB").onclick = () => { state.form.categorie = "cb"; render(); };
          document.getElementById("catBorne").onclick = () => { state.form.categorie = "borne"; render(); };
          document.getElementById("note").oninput = (e) => state.form.note = e.target.value;
        }

        document.getElementById("montant").oninput = (e) => state.form.montant = e.target.value;
        document.getElementById("date").oninput = (e) => state.form.date = e.target.value;

        document.getElementById("saveBtn").onclick = () => {
          const amt = parseFloat(state.form.montant);
          if (!amt || !state.form.date) { alert("Montant et date requis"); return; }
          
          const entry = { 
            id: Date.now(), 
            montant: amt, 
            date: state.form.date, 
            note: state.tab === "recettes" ? state.form.note.trim() : "",
            categorie: state.tab === "recettes" ? state.form.categorie : ""
          };
          
          if (state.tab === "recettes") state.recettes.push(entry);
          else state.fonds.push(entry);
          
          save();
          state.showForm = false;
          state.form = { montant: "", date: new Date().toISOString().slice(0,10), note: "", categorie: "especes" };
          render();
        };

        document.getElementById("cancelBtn").onclick = () => { state.showForm = false; render(); };
      }
    }

    window.delEntry = (id) => {
      if (!confirm("Supprimer cette entr√©e ?")) return;
      if (state.tab === "recettes") state.recettes = state.recettes.filter(r => r.id !== id);
      else state.fonds = state.fonds.filter(f => f.id !== id);
      save();
      render();
    };

    render();
  </script>

</body>
</html>